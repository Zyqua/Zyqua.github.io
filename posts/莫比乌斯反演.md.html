<!DOCTYPE html>
        <html>
            <head>
                <meta charset="utf-8"/>
                <title>blog</title>
                <link rel="stylesheet" type="text/css" href="../styles.css"/>
                <link rel="stylesheet" type="text/css" href="../markdownStyles.css"/>
                <script type="text/x-mathjax-config">
                    MathJax.Hub.Config({
                        extensions: ["tex2jax.js"],
                        jax: ["input/TeX", "output/HTML-CSS"],
                        tex2jax: {
                        inlineMath: [ ['$','$'] ],
                        displayMath: [ ['$$','$$'] ],
                        processEscapes: true
                        },
                        "HTML-CSS": { availableFonts: ["TeX"] }
                    });
                </script>
                <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
            </head>
            <body>
                <div class="body">
                <p class="title">inspiral.coding.me</p><h3 id="数论分块">数论分块</h3>
<h4 id="前置定理1">前置定理1</h4>
<p>$$\left\lfloor\dfrac{a}{bc}\right\rfloor=\left\lfloor\dfrac{\left\lfloor\dfrac{a}{b}\right\rfloor}{c}\right\rfloor$$</p>
<h5 id="证明">证明</h5>
<p>$$\left\lfloor\dfrac{a}{bc}\right\rfloor=\left\lfloor\dfrac{a}{b}\cdot\dfrac{1}{c}\right\rfloor=\left\lfloor\dfrac{1}{c}\left(\left\lfloor\dfrac{a}{b}\right\rfloor+r\right)\right\rfloor=\left\lfloor\dfrac{\left\lfloor\dfrac{a}{b}\right\rfloor}{c}+\dfrac{r}{c}\right\rfloor=\left\lfloor\dfrac{\left\lfloor\dfrac{a}{b}\right\rfloor}{c}\right\rfloor$$</p>
<h4 id="前置定理2">前置定理2</h4>
<p>$\left\lfloor\dfrac{a}{b}\right\rfloor$最多有$2\left\lfloor\sqrt a\right\rfloor$种取值。</p>
<h5 id="证明-1">证明</h5>
<p>当$b\le\left\lfloor\sqrt a\right\rfloor$时，$\left\lfloor\dfrac{a}{b}\right\rfloor$最多有$\left\lfloor\sqrt a\right\rfloor$种取值；</p>
<p>当$b&gt;\left\lfloor\sqrt a\right\rfloor$时，$\left\lfloor\dfrac{a}{b}\right\rfloor&lt;\left\lfloor\sqrt a\right\rfloor$，因此最多也只有$\left\lfloor\sqrt a\right\rfloor$种取值。</p>
<h4 id="引例">引例</h4>
<p>给定一个$n$，求$\sum\limits_{i=1}^{n}\left\lfloor\frac{n}{i}\right\rfloor$。$n\le{10}^{12}$。</p>
<p>朴素的$O(n)$求和会超时，因此尝试优化。把从$1$到$n$所有$\left\lfloor\frac{n}{i}\right\rfloor$的值列出来，显然有些连续区间中的所有数字是相同的。如果将这些连续区间每个都做到$O(1)$求和，那么根据前置定理2可以得出时间复杂度将会优化到$O(\sqrt n)$，不会超时。</p>
<p>于是问题转化为: 已知$i,n$且$i\le n$，求一个最大的$j$，使得$\left\lfloor\dfrac{n}{i}\right\rfloor=\left\lfloor\dfrac{n}{j}\right\rfloor$。</p>
<h4 id="定理">定理</h4>
<p>$$j=\left\lfloor\dfrac{n}{\left\lfloor\frac{n}{i}\right\rfloor}\right\rfloor$$
<del>不会证明</del></p>
<h4 id="应用">应用</h4>
<p>例如，$O(\sqrt n)$求出$\sum\limits_{i=1}^{n}\left\lfloor\frac{n}{i}\right\rfloor\mu(i)$。</p>
<p>子问题: 已知两个正整数$i,j$满足对于任意一个大于等于$i$，小于等于$j$的数$k$，其$\left\lfloor\frac{n}{k}\right\rfloor$的值都相等。要求$O(1)$求出$\sum\limits_{i\le k\le j}\left\lfloor\frac{n}{k}\right\rfloor\mu(k)$。</p>
<p>由于$\left\lfloor\frac{n}{k}\right\rfloor$的值都相等，因此根据乘法分配律我们可以把它提出来
$$\sum\limits_{i\le k\le j}\left\lfloor\frac{n}{k}\right\rfloor\mu(k)=\left\lfloor\frac{n}{i}\right\rfloor\sum_{i\le k\le j}\mu(k)$$
剩下的和式我们直接预处理出$\mu$函数的值，然后用前缀和就可以做到$O(1)$查询区间和了。</p>
<p>因此我们可以做到$O(1)$解决这个子问题，总复杂度$O(\sqrt n)$。</p>
<h3 id="数论函数">数论函数</h3>
<p>定义域在正整数上的函数称为数论函数。</p>
<h3 id="积性函数">积性函数</h3>
<p>若对于任意的互质的一对数$x$和$y$，有$f(x\times y)=f(x)\times f(y)$，则称函数$f$为积性函数。</p>
<p>常见的积性函数有
$$\varphi(n)=\sum_{i=1}^{n}[\gcd(i,n)=1]$$
$$d(n)=\sum\limits_{d|n}1=\prod\limits_{i=1}^{k}(e_i+1)$$
$$\sigma(n)=\sum\limits_{d|n}d$$
$$\sigma_k(n)=\sum\limits_{d|n}d^k$$
$$id(n)=n$$
$$id_k(n)=n^k$$
$$\varepsilon(n)=[n=1]$$
$$I(n)=1$$</p>
<h4 id="线性筛求积性函数">线性筛求积性函数</h4>
<p>以线性筛为基础，根据积性函数的性质，用$O(n)$复杂度求出指定的积性函数的自变量在$[1,n]$中的所有值。</p>
<p>以莫比乌斯函数为例。</p>
<pre><code class="language-cpp">for (int i = 2; i &lt;= n; i++) isprime[i] = true;
    mu[1] = 1;
    for (int i = 2; i &lt;= n; i++) {
        if (isprime[i]) {
            prime[++pcnt] = i;
            mu[i] = -1;
        }
        for (int j = 1; j &lt;= pcnt &amp;&amp; i * prime[j] &lt;= n; j++) {
            isprime[i * prime[j]] = false;
            if (!(i % prime[j])) {
                mu[i * prime[j]] = 0;
                break;
            }
            else mu[i * prime[j]] = -mu[i];
        }
    }</code></pre>
<h3 id="卷积">卷积</h3>
<p>$(f\ast g)(n)$称为函数$f$与$g$的卷积。</p>
<p>$$(f\ast g)(n)=\sum\limits_{\tau = -\infty}^{\infty}f(\tau)g(n-\tau)$$</p>
<h3 id="狄利克雷卷积">狄利克雷卷积</h3>
<p>若$f$和$g$都为数论函数，则$(f\ast g)(n)$称为数论函数$f$与$g$的狄利克雷卷积。</p>
<p>$$(f\ast g)(n)=\sum\limits_{d\ |\ n}f(d)g(\dfrac{n}{d})$$</p>
<h4 id="性质">性质</h4>
<p>卷积运算满足交换律、结合律。</p>
<p>积性函数的卷积仍为积性函数。</p>
<h4 id="单位元">单位元</h4>
<p>定义数论函数$\varepsilon(n)=[n=1]$，它是狄利克雷卷积的单位元。
若$f$为数论函数，则
$$(f\ast\varepsilon)(n)=(\varepsilon\ast f)(n)=\sum\limits_{d|n}\varepsilon(d)f(\dfrac{n}{d})=f(n)$$
从上式可以看出，在狄利克雷卷积的运算中，单位元类似于实数乘法运算中的$1$。</p>
<h3 id="莫比乌斯函数">莫比乌斯函数</h3>
<h4 id="定义">定义</h4>
<p>$\mu(n)$为莫比乌斯函数。</p>
<p>$$\sum\limits_{d\ |\ n}\mu(d)=[n=1]$$</p>
<p>这个定义等价于
$$\sum\limits_{d\ |\ n}\mu(d)=\varepsilon(n)$$</p>
<h4 id="性质-1">性质</h4>
<p>将$n$质因数分解$n=p_1^{a_1}p_2^{a_2}...p_{k}^{a_{k}}$，则:
$$\mu(n)=\begin{cases}1&amp;n=1\
(-1)^{k}&amp;\prod a_i=1\
0&amp;otherwise\end{cases}$$</p>
<hr>
<p>莫比乌斯函数是积性函数。
$$\mu(x\times y)=\mu(x)\times\mu(y)\ \ \ x\bot y$$</p>
<hr>
<h2 id="sumlimits_d--ndfracmudddfracvarphinn">$$\sum\limits_{d\ |\ n}\dfrac{\mu(d)}{d}=\dfrac{\varphi(n)}{n}$$</h2>
<p>$$id=\varphi\ast I$$
$$\varphi=id\ast\mu$$</p>
<hr>
<p>$\mu$与$I$互为逆元。
$$\mu \ast I=\sum\limits_{d|n}\mu(d)=[n=1]=\varepsilon(n)$$</p>
<h3 id="莫比乌斯反演">莫比乌斯反演</h3>
<h4 id="定理-1">定理</h4>
<p>若数论函数$f$与$g$满足</p>
<p>$$f(n)=\sum\limits_{d\ |\ n}g(d)$$</p>
<p>则</p>
<p>$$g(n)=\sum\limits_{d\ |\ n}\mu(\dfrac{n}{d})f(d)=\sum\limits_{d\ |\ n}\mu(d)f(\dfrac{n}{d})$$</p>
<h4 id="证明-2">证明</h4>
<p>$$\because f=g\ast I$$
$$\therefore f\ast\mu = g\ast I\ast\mu = g\ast(I\ast\mu) = g\ast\varepsilon = g$$</p>
<p>$$\therefore g=f\ast\mu=\sum\limits_{d|n}f(d)\mu(\dfrac{n}{d})$$</p>
<p>$$\text{又}\because f\ast\mu=\mu\ast f,\mu\ast f=\sum\limits_{d|n}\mu(d)f(\dfrac{n}{d})$$</p>
<p>$$\therefore g(n)=\sum\limits_{d\ |\ n}\mu(\dfrac{n}{d})f(d)=\sum\limits_{d\ |\ n}\mu(d)f(\dfrac{n}{d})$$</p>
<h3 id="例题1-haoi2011problem-b">例题1 [HAOI2011]Problem b</h3>
<p>给定$a,b,c,d,k$，求$\sum\limits_{i=a}^{b}\sum\limits_{j=c}^{d}[\gcd(i,j)=k]$。</p>
<h4 id="题解">题解</h4>
<p>我们直接求四次$\sum\limits_{i=1}^{n}\sum\limits_{j=1}^{m}[\gcd(i,j)=k]$，然后容斥原理搞一下即可(类似于二维前缀和)。问题转化为求$\sum\limits_{i=1}^{n}\sum\limits_{j=1}^{m}[\gcd(i,j)=k]$。</p>
<p>假设$n\le m$(否则交换$n$和$m$的值)。下面开始乱搞。</p>
<p>只有当$i,j$都是$k$的倍数时才会对答案产生贡献，因此只需要枚举$k$的倍数。
$$\sum_{i=1}^{\lfloor\frac{n}{k}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{k}\rfloor}[\gcd(i,j)=1]$$
等价于
$$\sum_{i=1}^{\lfloor\frac{n}{k}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{k}\rfloor}\varepsilon(\gcd(i,j))$$
由莫比乌斯函数的定义得
$$\sum_{i=1}^{\lfloor\frac{n}{k}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{k}\rfloor}\sum_{d\ |gcd(i,j)}\mu(d)$$
变换枚举顺序
$$\sum_{d=1}^{\lfloor\frac{n}{k}\rfloor}\sum_{i=1}^{\lfloor\frac{n}{k}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{k}\rfloor}[d\ |\gcd(i,j)]\cdot\mu(d)$$
这里同样只需要枚举$d$的倍数
$$\sum_{d=1}^{\lfloor\frac{n}{k}\rfloor}\sum_{i=1}^{\lfloor\frac{n}{dk}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{dk}\rfloor}[1\ |\gcd(i,j)]\cdot\mu(d)$$
$[1\ |\gcd(i,j)]$显然成立，因此得到
$$\sum_{d=1}^{\lfloor\frac{n}{k}\rfloor}\sum_{i=1}^{\lfloor\frac{n}{dk}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{dk}\rfloor}\mu(d)$$
等价于
$$\sum_{d=1}^{\lfloor\frac{n}{k}\rfloor}\left\lfloor\frac{n}{dk}\right\rfloor\left\lfloor\frac{m}{dk}\right\rfloor\mu(d)$$
对于这个式子，我们可以直接用数论分块求和，复杂度$O(\sqrt{\frac{n}{k}}+\sqrt{\frac{m}{k}})$。</p>
<p>下面是这道题的满分代码。(实际题目中有多次询问，为简化题意上面没有提到)</p>
<pre><code class="language-cpp">#include&lt;cstdio&gt;
using namespace std;

int n, prime[50100], mu[50100], pcnt;
bool isprime[50100];

inline int min(int a, int b) { return a &lt; b ? a : b; }
inline void swap(int &amp;a, int &amp;b) {
    int t = a;
    a = b;
    b = t;
}
inline int count(int n, int m, int k) {
    if (n &gt; m) swap(n, m);
    int ans = 0, l = 0, r = 0;
    n /= k, m /= k;
    while (l &lt; n) {
        l++, r = min(n / (n / l), m / (m / l));
        ans += (n / l) * (m / l) * (mu[r] - mu[l - 1]);
        l = r;
    }
    return ans;
}

int main() {
    scanf(&quot;%d&quot;, &amp;n);
    for (int i = 2; i &lt;= 50000; i++) isprime[i] = true;
    mu[1] = 1;
    for (int i = 2; i &lt;= 50000; i++) {
        if (isprime[i]) {
            mu[i] = -1;
            prime[++pcnt] = i;
        }
        for (int j = 1; j &lt;= pcnt &amp;&amp; i * prime[j] &lt;= 50000; j++) {
            isprime[i * prime[j]] = false;
            if (!(i % prime[j])) {
                mu[i * prime[j]] = 0;
                break;
            }
            else mu[i * prime[j]] = -mu[i];
        }
    }
    for (int i = 2; i &lt;= 50000; i++) mu[i] += mu[i - 1];
    for (int i = 1; i &lt;= n; i++) {
        int a, b, c, d, k;
        scanf(&quot;%d%d%d%d%d&quot;, &amp;a, &amp;b, &amp;c, &amp;d, &amp;k);
        printf(&quot;%d\n&quot;, count(b, d, k) - count(a - 1, d, k) - count(b, c - 1, k) + count(a - 1, c - 1, k));
    }
    return 0;
}</code></pre>
<h3 id="例题2-p4449-于神之怒加强版">例题2 P4449 于神之怒加强版</h3>
<p>求
$$\sum_{i=1}^{n}\sum_{j=1}^{m}\gcd(i,j)^k$$</p>
<h4 id="题解-1">题解</h4>
<p>变换枚举顺序
$$\sum_{d=1}^{n}d^k\sum_{i=1}^{n}\sum_{j=1}^{m}[\gcd(i,j)=d]$$
后面只需要枚举$d$的倍数
$$\sum_{d=1}^{n}d^k\sum_{i=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{d}\rfloor}[\gcd(i,j)=1]$$
等价于
$$\sum_{d=1}^{n}d^k\sum_{i=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{d}\rfloor}\varepsilon(\gcd(i,j))$$
由$\mu$函数的定义得
$$\sum_{d=1}^{n}d^k\sum_{i=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{d}\rfloor}\sum_{x|gcd(i,j)}\mu(x)$$
再变换枚举顺序
$$\sum_{d=1}^{n}d^k\sum_{x=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{i=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{d}\rfloor}[x\ |\gcd(i,j)]\ \mu(x)$$
后面只枚举$x$的倍数
$$\sum_{d=1}^{n}d^k\sum_{x=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{i=1}^{\lfloor\frac{n}{dx}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{dx}\rfloor}[1\ |\gcd(i,j)]\ \mu(x)$$
$[1\ |\gcd(i,j)]$显然成立
$$\sum_{d=1}^{n}d^k\sum_{x=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{i=1}^{\lfloor\frac{n}{dx}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{dx}\rfloor}\mu(x)$$
等价于
$$\sum_{d=1}^{n}d^k\sum_{x=1}^{\lfloor\frac{n}{d}\rfloor}\left\lfloor\frac{n}{dx}\right\rfloor\left\lfloor\frac{m}{dx}\right\rfloor\mu(x)$$
变换枚举顺序，令$s=dx$，然后先枚举$s$，再枚举$d$
$$\sum_{s=1}^{n}\sum_{d|s}d^k\left\lfloor\frac{n}{s}\right\rfloor\left\lfloor\frac{m}{s}\right\rfloor\mu(\frac{s}{d})$$
把公因式提出来
$$\sum_{s=1}^{n}\left\lfloor\frac{n}{s}\right\rfloor\left\lfloor\frac{m}{s}\right\rfloor\sum_{d|s}d^k\mu(\frac{s}{d})$$
$\sum\limits_{d|s}d^k\mu(\dfrac{s}{d})$实际上就是$(id_k\ast\mu)(s)$。$id_k$和$\mu$都是积性函数，因此$id_k\ast\mu$也是一个积性函数，可以用线性筛做到$O(n)$预处理。而前面两个整除式可以用数论分块来做，因此总复杂度$O(\sqrt n)$。
$$\sum_{s=1}^{n}\left\lfloor\frac{n}{s}\right\rfloor\left\lfloor\frac{m}{s}\right\rfloor\sum_{d|s}d^k\mu(\frac{s}{d})$$
$$f(n)=\sum_{d|n}d^k\mu(\frac{n}{d})$$
$$\sum_{s=1}^{n}\left\lfloor\frac{n}{s}\right\rfloor\left\lfloor\frac{m}{s}\right\rfloor f(s)$$
$$low_i=a_{1}^{e_1}$$</p>
<hr>
<p>$$low_i\not\ =i$$
$$f(i\cdot p_j)=f(p_jlow_i)f\left(\frac{i}{low_i}\right)$$</p>
<hr>
<p>$$low_i=i$$
$$(i=a^e)$$
$$f(i\cdot p_j)=f(a^{e+1})=\sum_{d|a^{e+1}}d^k\mu(\frac{a^{e+1}}{d})$$
$$f(a^e)=p^{(e-1)k}\mu(p)+p^{ek}=p^{ek}-p^{(e-1)k}$$</p>
<h3 id="例题3-p2257-yy的gcd">例题3 P2257 YY的GCD</h3>
<p>求
$$\sum_{i=1}^{n}\sum_{j=1}^{m}[\gcd(i,j)\in P]$$
$P$为所有质数的集合。</p>
<h4 id="题解-2">题解</h4>
<p>$$\sum_{d=1}^{n}[d\in P]\sum_{i=1}^{n}\sum_{j=1}^{m}[\gcd(i,j)=d]$$</p>
<p>$$\sum_{d=1}^{n}[d\in P]\sum_{i=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{d}\rfloor}[\gcd(i,j)=1]$$</p>
<p>$$\sum_{d=1}^{n}[d\in P]\sum_{i=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{d}\rfloor}\sum_{x|gcd(i,j)}\mu(x)$$</p>
<p>$$\sum_{d=1}^{n}[d\in P]\sum_{x=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{i=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{d}\rfloor}[x\ |\gcd(i,j)]\mu(x)$$</p>
<p>$$\sum_{d=1}^{n}[d\in P]\sum_{x=1}^{\lfloor\frac{n}{d}\rfloor}\sum_{i=1}^{\lfloor\frac{n}{dx}\rfloor}\sum_{j=1}^{\lfloor\frac{m}{dx}\rfloor}\mu(x)$$</p>
<p>$$\sum_{d=1}^{n}[d\in P]\sum_{x=1}^{\lfloor\frac{n}{d}\rfloor}\left\lfloor\frac{n}{dx}\right\rfloor\left\lfloor\frac{m}{dx}\right\rfloor\mu(x)$$</p>
<p>$$s=dx$$</p>
<p>$$\sum_{s=1}^{n}\sum_{d|s}[d\in P]\left\lfloor\frac{n}{s}\right\rfloor\left\lfloor\frac{m}{s}\right\rfloor\mu(\frac{s}{d})$$</p>
<p>$$\sum_{s=1}^{n}\left\lfloor\frac{n}{s}\right\rfloor\left\lfloor\frac{m}{s}\right\rfloor\sum_{d|s}^{n}[d\in P]\mu(\frac{s}{d})$$</p>
<a href="../posts.html" class="link" style="display:block; text-align:center;">return</a>
</div>
</body>
</html>